# 병렬 처리 시스템 설계 (Multi-Factory Architecture)

## 🏭 개념: 제1공장, 제2공장, 제3공장 병렬 운영

### 현재 시스템 (단일 공장)
```
[PM2 hidb:3000] → [process_batch.sh] → 2,376개 영상 → 약 5-6일 소요
```

### 병렬 시스템 (다중 공장)
```
[PM2 hidb-1:3001] → [worker-1] → 792개 영상 ──┐
[PM2 hidb-2:3002] → [worker-2] → 792개 영상 ──┼→ 약 2일 소요 (3배 빠름)
[PM2 hidb-3:3003] → [worker-3] → 792개 영상 ──┘
```

---

## 📊 성능 예측

| 워커 수 | 영상/워커 | 예상 시간 | 속도 향상 |
|--------|----------|---------|----------|
| 1개 (현재) | 2,376개 | 5-6일 | 1x |
| 2개 | 1,188개 | 2.5-3일 | 2x |
| 3개 | 792개 | 1.7-2일 | 3x |
| 4개 | 594개 | 1.2-1.5일 | 4x |

---

## 🛠️ 구현 방안 (3가지 옵션)

### ✅ 옵션 1: 포트 기반 병렬 처리 (추천)
**가장 간단하고 안정적**

#### 구조
- **PM2 멀티 인스턴스**: 각 포트에서 독립 실행
  - `hidb-1` (포트 3001)
  - `hidb-2` (포트 3002)
  - `hidb-3` (포트 3003)
- **동일 D1 데이터베이스 공유**: 모든 워커가 같은 DB 사용
- **작업 분할**: 각 워커가 서로 다른 영상 처리

#### 장점
- ✅ 구현 간단 (설정 파일만 수정)
- ✅ 안정성 높음 (워커 간 독립)
- ✅ 메모리 격리 (각 워커 별도 메모리)

#### 단점
- ❌ 메모리 사용량 증가 (워커당 700MB → 3개면 2.1GB)

---

### 옵션 2: DB Batch 분할 (중급)
**DB에 여러 배치 생성**

#### 구조
- **Batch 1**: 영상 1~800 → Worker 1
- **Batch 2**: 영상 801~1600 → Worker 2
- **Batch 3**: 영상 1601~2376 → Worker 3

#### 장점
- ✅ 논리적으로 깔끔
- ✅ 진행률 개별 추적

#### 단점
- ❌ DB 스키마 수정 필요
- ❌ 배치 생성 스크립트 필요

---

### 옵션 3: Process ID 기반 분산 (고급)
**단일 PM2에서 멀티 프로세스**

#### 구조
- PM2 Cluster 모드 (3 instances)
- 각 프로세스가 `video_id % 3 == process_id` 조건으로 처리

#### 장점
- ✅ 메모리 효율적
- ✅ PM2 자동 로드밸런싱

#### 단점
- ❌ Cloudflare Workerd와 호환성 문제 가능
- ❌ 복잡한 코드 수정 필요

---

## 🎯 추천: 옵션 1 (포트 기반)

### 이유
1. **구현 속도**: 1시간 내 완료 가능
2. **안정성**: 워커 독립 실행 (한 워커 다운 → 다른 워커 정상)
3. **확장성**: 워커 추가/제거 쉬움

### 필요한 파일
```
ecosystem-multi.config.cjs  # 3개 PM2 인스턴스 설정
worker-1.sh                 # Worker 1용 배치 스크립트
worker-2.sh                 # Worker 2용 배치 스크립트
worker-3.sh                 # Worker 3용 배치 스크립트
monitor-multi.sh            # 3개 워커 모니터링
```

---

## 📝 구현 체크리스트

### 1단계: PM2 멀티 인스턴스 설정
- [ ] `ecosystem-multi.config.cjs` 생성 (3개 앱)
- [ ] 포트: 3001, 3002, 3003
- [ ] 메모리 제한: 각 700MB

### 2단계: 작업 분할 로직
- [ ] API에 `worker_id` 파라미터 추가
- [ ] DB 쿼리 수정: `WHERE video_id % 3 = worker_id`
- [ ] 각 워커별 배치 스크립트

### 3단계: 모니터링
- [ ] 3개 워커 동시 모니터링 스크립트
- [ ] 통합 로그 뷰어
- [ ] 진행률 대시보드

### 4단계: 테스트
- [ ] 단일 워커 테스트
- [ ] 2개 워커 병렬 테스트
- [ ] 3개 워커 풀 테스트

---

## ⚠️ 주의사항

### 메모리 요구사항
- **1개 워커**: 700MB
- **3개 워커**: 2.1GB (샌드박스 메모리: 987MB → 부족)

### 해결 방안
1. **메모리 최적화**: 각 워커 250MB 제한 → 750MB 총합 ✅
2. **워커 2개만 실행**: 500MB 총합 → 안전 ✅
3. **순차 시작**: Worker 1 → 대기 → Worker 2 시작

---

## 🚀 예상 효과 (2개 워커 기준)

| 항목 | 현재 (1개) | 병렬 (2개) | 개선도 |
|-----|----------|----------|--------|
| **처리 시간** | 5-6일 | 2.5-3일 | 2배 빠름 |
| **메모리** | 700MB | 500MB (각 250MB) | 안전 |
| **안정성** | 중간 | 높음 (워커 독립) | 향상 |

---

## 💡 결론

**2개 워커 병렬 처리**가 최적입니다:
- ✅ 메모리 안전 (987MB 샌드박스에서 500MB 사용)
- ✅ 처리 속도 2배 향상 (5일 → 2.5일)
- ✅ 구현 간단 (1시간 내 완료)
- ✅ 안정성 확보 (워커 독립 실행)

**3개 워커는 메모리 부족으로 권장하지 않습니다.**

---

## 다음 단계

사용자 승인 시 즉시 구현 가능:
1. `ecosystem-multi.config.cjs` 생성
2. 워커별 배치 스크립트 생성
3. API에 `worker_id` 로직 추가
4. 테스트 및 배포

**구현을 진행할까요?**
